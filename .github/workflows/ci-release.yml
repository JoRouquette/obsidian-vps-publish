name: Workspace CI, Release and Publishing

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '22.14.0'
  REGISTRY_URL: ${{ vars.REGISTRY_URL }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Lint, test and build workspace
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Lint (Nx)
        run: npm run lint

      - name: Documentation validation
        run: npm run docs:check

      - name: Build (Nx)
        run: npm run build

      - name: Test (Nx)
        run: npm run test

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          if-no-files-found: error
          retention-days: 1

  # TODO: Re-enable e2e tests once SSR configuration is fixed
  # e2e:
  #   name: End-to-end tests
  #   needs: quality
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Setup Node
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: npm

  #     - name: Install dependencies
  #       run: npm install --no-audit --no-fund --ignore-scripts
  #       env:
  #         HUSKY: 0

  #     - name: Install Playwright browsers
  #       run: npx playwright install chromium --with-deps

  #     - name: Run E2E tests
  #       run: npx nx e2e site
  #       env:
  #         CI: true

  #     - name: Upload Playwright report
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: playwright-report
  #         path: apps/site/playwright-report
  #         retention-days: 7

  performance:
    name: Performance budget validation
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.14.x

      - name: Create test content
        run: |
          mkdir -p tmp/site-content tmp/assets
          echo '{"version":"1.0.0","generatedAt":"'$(date -Iseconds)'","pages":[{"id":"index","title":"Home","slug":"index","route":"/","description":"Homepage","publishedAt":"'$(date -Iseconds)'","isCustomIndex":true},{"id":"test","title":"Test Page","slug":"test","route":"/test","description":"Test content page","publishedAt":"'$(date -Iseconds)'"}],"canonicalMap":{}}' > tmp/site-content/_manifest.json
          echo '<!DOCTYPE html><html><head><title>Home</title><meta name="description" content="Homepage"></head><body><h1>Welcome</h1><p>Content site homepage.</p></body></html>' > tmp/site-content/index.html
          echo '<!DOCTYPE html><html><head><title>Test Page</title><meta name="description" content="Test content page"></head><body><h1>Test Page</h1><p>Lorem ipsum dolor sit amet.</p></body></html>' > tmp/site-content/test.html

      - name: Verify Angular build
        run: |
          echo "Checking Angular build artifacts..."
          ls -la dist/apps/site/ || true
          ls -la dist/apps/site/browser/ || true
          if [ ! -f "dist/apps/site/browser/index.html" ]; then
            echo "ERROR: index.html not found in dist/apps/site/browser/"
            echo "Checking for index.csr.html..."
            if [ -f "dist/apps/site/browser/index.csr.html" ]; then
              echo "Found index.csr.html, renaming to index.html"
              cp dist/apps/site/browser/index.csr.html dist/apps/site/browser/index.html
            else
              echo "Neither index.html nor index.csr.html found!"
              exit 1
            fi
          fi
          echo "✓ index.html verified"

      - name: Run Lighthouse CI
        env:
          BASE_URL: http://localhost:3000
          API_KEY: ci-test-key
          CONTENT_ROOT: ${{ github.workspace }}/tmp/site-content
          ASSETS_ROOT: ${{ github.workspace }}/tmp/assets
          UI_ROOT: ${{ github.workspace }}/dist/apps/site/browser
          UI_SERVER_ROOT: ${{ github.workspace }}/dist/apps/site/server
          SSR_ENABLED: 'false'
          LOGGER_LEVEL: warn
        run: |
          # Start server in background
          node dist/apps/node/main.js &
          SERVER_PID=$!

          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            sleep 1
          done

          # Test server is responding
          echo "Testing server endpoints..."
          curl -I http://localhost:3000/ || echo "WARNING: Root endpoint failed"
          curl -I http://localhost:3000/test || echo "WARNING: Test endpoint failed"

          # Run Lighthouse CI
          lhci autorun --collect.startServerCommand="" || LHCI_EXIT=$?

          # Cleanup
          kill $SERVER_PID 2>/dev/null || true

          exit ${LHCI_EXIT:-0}

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 7

  semantic-release:
    name: Semantic release
    needs: [quality, performance]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

  docker-images:
    name: Build and publish Docker images
    needs: semantic-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout latest release commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest branch state
        run: |
          git fetch origin "${GITHUB_REF_NAME}"
          git checkout "origin/${GITHUB_REF_NAME}"
          git fetch --tags --force

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Compute image tags
        id: vars
        run: |
          VERSION=$(git describe --tags --abbrev=0 || node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to private registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push to private registry
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.version }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.version }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  obsidian-plugin-release:
    name: Obsidian plugin release
    needs: semantic-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Pull latest changes from main
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Package Obsidian plugin
        run: npm run package:plugin

      - name: Read manifest data (id/version)
        id: manifest
        run: |
          PLUGIN_ID=$(node -e "console.log(require('./manifest.json').id)")
          VERSION=$(node -e "console.log(require('./manifest.json').version)")
          echo "plugin_id=$PLUGIN_ID" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create plugin bundle ZIP
        run: |
          cd dist
          zip -r ${{ steps.manifest.outputs.plugin_id }}.zip ${{ steps.manifest.outputs.plugin_id }}

      - name: Get latest tag
        id: latest_tag
        run: |
          git fetch --tags --force
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          echo "tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Verify tag matches manifest.json version
        run: |
          TAG_VERSION="${{ steps.latest_tag.outputs.version }}"
          MANIFEST_VERSION="${{ steps.manifest.outputs.version }}"

          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "⚠️  Tag version ($TAG_VERSION) does not match manifest.json version ($MANIFEST_VERSION)"
            echo "This might be expected if semantic-release just created a new tag."
            echo "Using manifest.json version for release."
          fi

      - name: Create or update GitHub Release with plugin assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.manifest.outputs.version }}
          name: Publish to VPS v${{ steps.manifest.outputs.version }}
          files: |
            dist/${{ steps.manifest.outputs.plugin_id }}.zip
            dist/${{ steps.manifest.outputs.plugin_id }}/main.js
            dist/${{ steps.manifest.outputs.plugin_id }}/manifest.json
            dist/${{ steps.manifest.outputs.plugin_id }}/styles.css
            dist/${{ steps.manifest.outputs.plugin_id }}/versions.json
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
